<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILLEGAL RAVE VJ SYSTEM - Full Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: #0f0;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Scanlines effect */
        #container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 0, 0.03) 2px,
                rgba(0, 255, 0, 0.03) 4px
            );
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
            animation: scanlines 8s linear infinite;
        }
        
        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }
        
        /* Left panel - Components */
        #leftPanel {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            border-right: 2px solid #0f0;
            z-index: 10000;
            overflow-y: auto;
            padding: 15px;
        }
        
        #leftPanel h2 {
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 5px;
        }
        
        .panel-section {
            margin-bottom: 20px;
        }
        
        .panel-section h3 {
            color: #0ff;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .btn {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 6px 12px;
            margin: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            transition: all 0.2s;
            font-size: 11px;
            display: inline-block;
        }
        
        .btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 10px #0f0;
        }
        
        .btn.active {
            background: #0f0;
            color: #000;
        }
        
        .btn.danger {
            border-color: #f00;
            color: #f00;
        }
        
        .btn.danger:hover {
            background: #f00;
            color: #000;
        }
        
        /* Right panel - Layers */
        #rightPanel {
            position: fixed;
            right: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            border-left: 2px solid #0f0;
            z-index: 10000;
            overflow-y: auto;
            padding: 15px;
        }
        
        .layer-item {
            background: rgba(0, 50, 0, 0.3);
            border: 1px solid #0f0;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        
        .layer-item.active {
            border-color: #0ff;
            background: rgba(0, 100, 100, 0.3);
        }
        
        .layer-name {
            color: #0f0;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .layer-controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .layer-controls .btn {
            font-size: 10px;
            padding: 4px 8px;
        }
        
        /* Top bar - Stats & Controls */
        #topBar {
            position: fixed;
            top: 0;
            left: 300px;
            right: 280px;
            height: 60px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid #0f0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .stat-group {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            font-size: 11px;
        }
        
        .stat-label {
            color: #0f0;
        }
        
        .stat-value {
            color: #0ff;
            font-weight: bold;
        }
        
        /* Bottom bar - Audio controls */
        #bottomBar {
            position: fixed;
            bottom: 0;
            left: 300px;
            right: 280px;
            height: 50px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #0f0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        #bottomBar .btn {
            font-size: 14px;
            padding: 8px 20px;
        }
        
        /* Component list */
        .component-item {
            background: rgba(0, 50, 0, 0.2);
            border: 1px solid #0f0;
            padding: 6px;
            margin-bottom: 3px;
            border-radius: 3px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .component-name {
            color: #0ff;
        }
        
        .component-item .btn {
            padding: 2px 6px;
            margin: 0 2px;
        }
        
        /* Toggle panels button */
        .toggle-panels {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
        }
        
        /* Slider */
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        .slider-group {
            margin: 10px 0;
        }
        
        .slider-group label {
            font-size: 10px;
            color: #0f0;
            display: block;
            margin-bottom: 3px;
        }
        
        /* Chaos effects */
        body.chaos-shake {
            animation: shake 0.1s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-5px, 5px) rotate(-1deg); }
            50% { transform: translate(5px, -5px) rotate(1deg); }
            75% { transform: translate(-5px, -5px) rotate(-0.5deg); }
        }
        
        body.chaos-invert {
            filter: invert(1);
        }
        
        body.chaos-chromatic #container {
            filter: blur(1px);
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <!-- LEFT PANEL: Add Components -->
    <div id="leftPanel">
        <h2>üéõÔ∏è COMPONENT PALETTE</h2>
        
        <div class="panel-section">
            <h3>üîä Add Speakers</h3>
            <div style="margin-bottom: 10px; font-size: 10px; color: #0ff;">
                LEFT/RIGHT channels, frequency bands:
            </div>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'subwoofer')" title="20-60Hz">üî¥ Subwoofer</button>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'bass')" title="60-250Hz">üü† Bass</button>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'lowmid')" title="250-500Hz">üü° Low Mid</button>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'mid')" title="500-2kHz">üü¢ Mid</button>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'highmid')" title="2-4kHz">üîµ High Mid</button>
            <button class="btn" onclick="addComponent('SpeakerComponent', 'tweeter')" title="4-20kHz">üü£ Tweeter</button>
        </div>
        
        <div class="panel-section">
            <h3>‚ú® Add Effects</h3>
            <div style="margin-bottom: 10px; font-size: 10px; color: #0ff;">
                Lasers react to frequencies:
            </div>
            <button class="btn" onclick="addComponent('LaserComponent', 'left')" title="Bass reactive">üî¶ Laser L (Bass)</button>
            <button class="btn" onclick="addComponent('LaserComponent', 'right')" title="Mid reactive">üî¶ Laser R (Mid)</button>
            <button class="btn" onclick="addComponent('LaserComponent', 'center')" title="Treble reactive">üî¶ Laser C (Treble)</button>
            <div style="margin: 10px 0 5px 0; font-size: 10px; color: #0ff;">
                Strobes react to punch/peak:
            </div>
            <button class="btn" onclick="addComponent('StrobeComponent', 'top-left')" title="Punch > 0.7">üí° Strobe TL</button>
            <button class="btn" onclick="addComponent('StrobeComponent', 'top-right')" title="Punch > 0.7">üí° Strobe TR</button>
            <button class="btn" onclick="addComponent('StrobeComponent', 'bottom-left')" title="Peak > 0.9">üí° Strobe BL</button>
            <button class="btn" onclick="addComponent('StrobeComponent', 'bottom-right')" title="Peak > 0.9">üí° Strobe BR</button>
            <div style="margin: 10px 0 5px 0; font-size: 10px; color: #0ff;">
                Other:
            </div>
            <button class="btn" onclick="addComponent('ParticleComponent')" title="Bass reactive particles">‚ú® Particles</button>
            <button class="btn" onclick="addComponent('LogoComponent')" title="Center spinning logo">‚≠ï Logo</button>
        </div>
        
        <div class="panel-section">
            <h3>üé¨ Presets</h3>
            <div style="margin-bottom: 8px; font-size: 10px; color: #0ff;">
                Full System = background 03.png + 12 speakers + 3 lasers + 4 strobes + logo
            </div>
            <button class="btn" onclick="loadPreset('full-system')" title="Complete rave experience with story">üé¨ Full System</button>
            <button class="btn" onclick="loadPreset('minimal')" title="Single bass speaker">üìª Minimal</button>
            <button class="btn" onclick="loadPreset('chaos')" title="30 random speakers">üí• Chaos</button>
            <button class="btn danger" onclick="clearAll()" title="Remove all components">üóëÔ∏è Clear All</button>
        </div>
        
        <div class="panel-section">
            <h3>üìã Active Components</h3>
            <div id="componentList"></div>
        </div>
    </div>
    
    <!-- RIGHT PANEL: Layers -->
    <div id="rightPanel">
        <h2>üìÇ LAYER MANAGER</h2>
        
        <div class="panel-section">
            <button class="btn" onclick="createNewLayer()">‚ûï New Layer</button>
            <button class="btn" onclick="deleteSelectedLayer()">üóëÔ∏è Delete</button>
        </div>
        
        <div class="panel-section">
            <h3>üî≤ Grid System</h3>
            <button class="btn" id="gridSnapBtn" onclick="toggleGridSnap()">Snap: OFF</button>
            <button class="btn" id="gridShowBtn" onclick="toggleGridShow()">Show: OFF</button>
            <div class="slider-group">
                <label>Grid Size: <span id="gridSizeValue">50</span>px</label>
                <input type="range" min="10" max="200" value="50" id="gridSizeSlider" oninput="updateGridSize(this.value)">
            </div>
        </div>
        
        <div class="panel-section">
            <h3>üìö Layers</h3>
            <div id="layerList"></div>
        </div>
    </div>
    
    <!-- TOP BAR: Stats -->
    <div id="topBar">
        <div class="stat-group">
            <div class="stat">
                <span class="stat-label">FPS:</span>
                <span class="stat-value" id="fps">60</span>
            </div>
            <div class="stat">
                <span class="stat-label">Components:</span>
                <span class="stat-value" id="componentCount">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Layers:</span>
                <span class="stat-value" id="layerCount">0</span>
            </div>
            <div class="stat">
                <span class="stat-label">Beat:</span>
                <span class="stat-value" id="beatStatus">‚ùå</span>
            </div>
        </div>
        
        <div class="stat-group">
            <div class="stat">
                <span class="stat-label">Bass:</span>
                <span class="stat-value" id="bassLevel">0%</span>
            </div>
            <div class="stat">
                <span class="stat-label">Energy:</span>
                <span class="stat-value" id="energyLevel">0%</span>
            </div>
        </div>
        
        <div class="stat-group">
            <button class="btn" onclick="exportScene()">üíæ Save</button>
            <button class="btn" onclick="importScene()">üìÇ Load</button>
        </div>
    </div>
    
    <!-- BOTTOM BAR: Audio Controls -->
    <div id="bottomBar">
        <button class="btn" id="startBtn">‚ñ∂Ô∏è START AUDIO</button>
        <button class="btn" id="stopBtn">‚èπÔ∏è STOP</button>
        <button class="btn toggle-panels" id="togglePanelsBtn">HIDE PANELS [TAB]</button>
    </div>
    
    <!-- Load Framework -->
    <script src="./rave-framework/engine/AudioAnalyzer.js"></script>
    <script src="./rave-framework/engine/ComponentManager.js"></script>
    <script src="./rave-framework/engine/LayerManager.js"></script>
    <script src="./rave-framework/engine/GridSystem.js"></script>
    <script src="./rave-framework/components/BaseComponent.js"></script>
    <script src="./rave-framework/components/SpeakerComponent.js"></script>
    <script src="./rave-framework/components/LaserComponent.js"></script>
    <script src="./rave-framework/components/StrobeComponent.js"></script>
    <script src="./rave-framework/components/LogoComponent.js"></script>
    <script src="./rave-framework/components/ParticleComponent.js"></script>
    <!-- SlideshowComponent removed - using static background 03.png -->
    
    <script>
        // Framework instances
        let audioAnalyzer = null;
        let componentManager = null;
        let layerManager = null;
        let gridSystem = null;
        let isRunning = false;
        let lastTime = 0;
        let fps = 60;
        let frameCount = 0;
        let fpsTime = 0;
        
        // UI state
        let panelsVisible = true;
        let selectedLayer = null;
        let componentCounter = 0;
        
        // Audio stream URL
        const AUDIO_URL = 'https://radio.freeundergroundtekno.org/listen/free_underground_tekno/radio.mp3';
        
        /**
         * Initialize framework
         */
        async function init() {
            console.log('üöÄ Initializing ILLEGAL RAVE VJ SYSTEM...');
            
            const container = document.getElementById('container');
            
            // Initialize systems
            audioAnalyzer = new AudioAnalyzer({ fftSize: 2048, smoothing: 0.8 });
            componentManager = new ComponentManager(container);
            layerManager = new LayerManager();
            gridSystem = new GridSystem({ gridSize: 50, showGrid: false });
            
            gridSystem.init(container);
            
            // Register component types (removed SlideshowComponent - using static background)
            componentManager.registerType('SpeakerComponent', SpeakerComponent);
            componentManager.registerType('LaserComponent', LaserComponent);
            componentManager.registerType('StrobeComponent', StrobeComponent);
            componentManager.registerType('LogoComponent', LogoComponent);
            componentManager.registerType('ParticleComponent', ParticleComponent);
            
            // Create default layers (no slideshow, using static background 03.png)
            layerManager.createLayer('Background', { zIndex: 0 });
            layerManager.createLayer('Speakers', { zIndex: 100 });
            layerManager.createLayer('Effects', { zIndex: 200 });
            layerManager.createLayer('Foreground', { zIndex: 300 });
            
            selectedLayer = layerManager.layerOrder[1]; // Speakers layer
            
            // Load full system preset
            loadPreset('full-system');
            
            // Setup event listeners
            setupEventListeners();
            
            // Update UI
            updateLayerList();
            updateComponentList();
            
            console.log('‚úÖ Framework initialized');
        }
        
        /**
         * Add component
         */
        function addComponent(type, subtype) {
            const positions = gridSystem.getPresetPositions();
            let config = {
                id: `${type}_${componentCounter++}`,
                x: positions.center.x,
                y: positions.center.y
            };
            
            // Type-specific config
            if (type === 'SpeakerComponent') {
                config.speakerType = subtype;
                config.channel = 'mono';
                config.size = 150;
            } else if (type === 'LaserComponent') {
                config.position = subtype;
                config.color = subtype === 'left' ? '#ff00ff' : subtype === 'right' ? '#00ff00' : '#00ffff';
            } else if (type === 'StrobeComponent') {
                config.corner = subtype;
                config.color = '#ff0000';
            } else if (type === 'ParticleComponent') {
                config.maxParticles = 100;
                config.particleColor = '#00ffff';
            } else if (type === 'LogoComponent') {
                config.text = 'RAVE';
                config.size = 300;
            } else if (type === 'SlideshowComponent') {
                config.images = [
                    './rave-framework/assets/01.png',
                    './rave-framework/assets/02.png',
                    './rave-framework/assets/03.png',
                    './rave-framework/assets/04.png',
                    './rave-framework/assets/05.png',
                    './rave-framework/assets/06.png',
                    './rave-framework/assets/07.png',
                    './rave-framework/assets/08.png'
                ];
                config.transitionDuration = 8;
                config.loop = true;
            }
            
            const component = componentManager.addComponent(type, config);
            
            if (component && selectedLayer) {
                layerManager.addComponentToLayer(component.id, selectedLayer);
            }
            
            updateComponentList();
            console.log(`‚úÖ Added ${type} (${subtype || 'default'})`);
        }
        
        /**
         * Remove component
         */
        function removeComponent(componentId) {
            // Remove from layer
            const layerId = layerManager.getComponentLayer(componentId);
            if (layerId) {
                layerManager.removeComponentFromLayer(componentId, layerId);
            }
            
            // Remove from manager
            componentManager.removeComponent(componentId);
            updateComponentList();
        }
        
        /**
         * Load preset
         */
        function loadPreset(presetName) {
            clearAll();
            
            if (presetName === 'full-system') {
                buildFullSystemPreset();
            } else if (presetName === 'minimal') {
                buildMinimalPreset();
            } else if (presetName === 'chaos') {
                buildChaosPreset();
            }
            
            updateComponentList();
        }
        
        /**
         * Build full system preset
         */
        function buildFullSystemPreset() {
            // STATIC BACKGROUND - Image 03 (Prime Vibrazioni)
            const container = document.getElementById('container');
            const background = document.createElement('div');
            background.id = 'staticBackground';
            background.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('./rave-framework/assets/03.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                z-index: 0;
                opacity: 0.7;
            `;
            container.appendChild(background);
            console.log('üé® STATIC BACKGROUND: 03.png (Prime Vibrazioni) loaded');
            
            // CONFIGURAZIONE MURO DI CASSE STEREO
            const speakerTypes = [
                { type: 'subwoofer', size: 200, label: 'SUB BASS' },
                { type: 'bass', size: 180, label: 'BASS' },
                { type: 'lowmid', size: 160, label: 'LOW MID' },
                { type: 'mid', size: 140, label: 'MID' },
                { type: 'highmid', size: 120, label: 'HIGH MID' },
                { type: 'tweeter', size: 100, label: 'TREBLE' }
            ];
            
            // Posizioni per stack verticali
            const leftX = 450;   // Stack sinistra
            const rightX = window.innerWidth - 450; // Stack destra
            const startY = 150;
            const spacing = 135;
            
            const speakerLayer = layerManager.layerOrder[1]; // Speakers
            const effectsLayer = layerManager.layerOrder[2]; // Effects
            const foregroundLayer = layerManager.layerOrder[3]; // Foreground
            
            console.log('üîä Building STEREO SOUND SYSTEM...');
            console.log(`   LEFT stack at x=${leftX}`);
            console.log(`   RIGHT stack at x=${rightX}`);
            
            // LEFT CHANNEL STACK (dal basso verso l'alto)
            speakerTypes.forEach((spec, i) => {
                const leftId = `speaker_left_${spec.type}`;
                const component = componentManager.addComponent('SpeakerComponent', {
                    id: leftId,
                    speakerType: spec.type,
                    channel: 'left',
                    x: leftX,
                    y: startY + (i * spacing),
                    size: spec.size
                });
                if (component) {
                    layerManager.addComponentToLayer(leftId, speakerLayer);
                    console.log(`   ‚úÖ LEFT ${spec.label} at (${leftX}, ${startY + (i * spacing)})`);
                }
            });
            
            // RIGHT CHANNEL STACK (dal basso verso l'alto)
            speakerTypes.forEach((spec, i) => {
                const rightId = `speaker_right_${spec.type}`;
                const component = componentManager.addComponent('SpeakerComponent', {
                    id: rightId,
                    speakerType: spec.type,
                    channel: 'right',
                    x: rightX,
                    y: startY + (i * spacing),
                    size: spec.size
                });
                if (component) {
                    layerManager.addComponentToLayer(rightId, speakerLayer);
                    console.log(`   ‚úÖ RIGHT ${spec.label} at (${rightX}, ${startY + (i * spacing)})`);
                }
            });
            
            console.log(`üîä Total speakers: ${speakerTypes.length * 2} (${speakerTypes.length} LEFT + ${speakerTypes.length} RIGHT)`);
            
            // CENTER LOGO
            const logoId = 'center_logo';
            const logoComponent = componentManager.addComponent('LogoComponent', {
                id: logoId,
                text: 'FUT',
                size: 350,
                color: '#0f0',
                x: window.innerWidth / 2,
                y: window.innerHeight / 2
            });
            if (logoComponent) {
                layerManager.addComponentToLayer(logoId, foregroundLayer);
                console.log(`   ‚≠ï CENTER LOGO at (${window.innerWidth / 2}, ${window.innerHeight / 2})`);
            }
            
            // LASERS (3 beams)
            const laserConfigs = [
                { pos: 'left', color: '#ff00ff', label: 'LEFT (magenta, bass)' },
                { pos: 'right', color: '#00ff00', label: 'RIGHT (green, mid)' },
                { pos: 'center', color: '#00ffff', label: 'CENTER (cyan, treble)' }
            ];
            
            laserConfigs.forEach(config => {
                const laserId = `laser_${config.pos}`;
                const laserComponent = componentManager.addComponent('LaserComponent', {
                    id: laserId,
                    position: config.pos,
                    color: config.color,
                    width: 800,
                    height: 4
                });
                if (laserComponent) {
                    layerManager.addComponentToLayer(laserId, effectsLayer);
                    console.log(`   üî¶ LASER ${config.label}`);
                }
            });
            
            // STROBES (4 corners)
            const strobeConfigs = [
                { corner: 'top-left', color: '#ff0000', metric: 'punch', label: 'TL (red, punch)' },
                { corner: 'top-right', color: '#00ff00', metric: 'punch', label: 'TR (green, punch)' },
                { corner: 'bottom-left', color: '#0000ff', metric: 'peak', label: 'BL (blue, peak)' },
                { corner: 'bottom-right', color: '#ff00ff', metric: 'peak', label: 'BR (magenta, peak)' }
            ];
            
            strobeConfigs.forEach(config => {
                const strobeId = `strobe_${config.corner}`;
                const strobeComponent = componentManager.addComponent('StrobeComponent', {
                    id: strobeId,
                    corner: config.corner,
                    color: config.color,
                    size: 200,
                    threshold: config.metric === 'punch' ? 0.7 : 0.9,
                    metric: config.metric
                });
                if (strobeComponent) {
                    layerManager.addComponentToLayer(strobeId, effectsLayer);
                    console.log(`   üí° STROBE ${config.label}`);
                }
            });
            
            console.log('‚úÖ FULL SYSTEM LOADED:');
            console.log('   - 1 Static Background (03.png - Prime Vibrazioni)');
            console.log('   - 12 Speakers (6 freq √ó 2 channels)');
            console.log('   - 3 Lasers (bass, mid, treble)');
            console.log('   - 4 Strobes (punch√ó2, peak√ó2)');
            console.log('   - 1 Center Logo');
            console.log('   = 20 COMPONENTS + 1 BACKGROUND');
        
        /**
         * Build minimal preset
         */
        function buildMinimalPreset() {
            componentManager.addComponent('SpeakerComponent', {
                id: 'bass_center',
                speakerType: 'bass',
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                size: 300
            });
        }
        
        /**
         * Build chaos preset
         */
        function buildChaosPreset() {
            const types = ['subwoofer', 'bass', 'lowmid', 'mid', 'highmid', 'tweeter'];
            for (let i = 0; i < 30; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                componentManager.addComponent('SpeakerComponent', {
                    speakerType: type,
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    size: 50 + Math.random() * 150
                });
            }
        }
        
        /**
         * Clear all
         */
        function clearAll() {
            componentManager.clear();
            updateComponentList();
        }
        
        /**
         * Start audio
         */
        async function start() {
            if (isRunning) return;
            const success = await audioAnalyzer.init(AUDIO_URL);
            if (!success) {
                alert('Audio init failed');
                return;
            }
            isRunning = true;
            lastTime = performance.now();
            requestAnimationFrame(animate);
        }
        
        /**
         * Stop
         */
        function stop() {
            isRunning = false;
        }
        
        /**
         * Animation loop
         */
        function animate(currentTime) {
            if (!isRunning) return;
            
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;
            
            frameCount++;
            fpsTime += deltaTime;
            if (fpsTime >= 1.0) {
                fps = Math.round(frameCount / fpsTime);
                frameCount = 0;
                fpsTime = 0;
            }
            
            audioAnalyzer.analyze();
            const audioData = audioAnalyzer.getData();
            
            componentManager.update(audioData, deltaTime);
            componentManager.render(audioData);
            
            applyGlobalEffects(audioData);
            updateStats(audioData);
            
            requestAnimationFrame(animate);
        }
        
        /**
         * Global effects
         */
        function applyGlobalEffects(audioData) {
            const { bands, metrics } = audioData;
            
            document.body.classList.toggle('chaos-shake', bands.subBass && bands.subBass.value > 0.85);
            document.body.classList.toggle('chaos-invert', metrics.peak > 0.95);
            document.body.classList.toggle('chaos-chromatic', 
                bands.bass && bands.subBass && bands.bass.value > 0.8 && bands.subBass.value > 0.8);
        }
        
        /**
         * Update stats
         */
        function updateStats(audioData) {
            document.getElementById('fps').textContent = fps;
            document.getElementById('componentCount').textContent = componentManager.stats.componentCount;
            document.getElementById('layerCount').textContent = layerManager.layers.size;
            document.getElementById('beatStatus').textContent = audioData.beat.detected ? '‚úÖ' : '‚ùå';
            document.getElementById('bassLevel').textContent = Math.round((audioData.bands.bass?.value || 0) * 100) + '%';
            document.getElementById('energyLevel').textContent = Math.round((audioData.metrics.energy || 0) * 100) + '%';
        }
        
        /**
         * Update component list
         */
        function updateComponentList() {
            const list = document.getElementById('componentList');
            list.innerHTML = '';
            
            if (componentManager.components.size === 0) {
                list.innerHTML = '<div style="font-size: 10px; color: #666; padding: 10px;">No components yet. Click buttons above to add.</div>';
                return;
            }
            
            componentManager.components.forEach((component, id) => {
                const div = document.createElement('div');
                div.className = 'component-item';
                
                // Get component info
                let info = '';
                if (component.type === 'SpeakerComponent') {
                    const freq = component.speakerType.toUpperCase();
                    const ch = component.channel.toUpperCase();
                    info = `üîä ${freq} [${ch}]`;
                } else if (component.type === 'LaserComponent') {
                    info = `üî¶ ${component.position}`;
                } else if (component.type === 'StrobeComponent') {
                    info = `üí° ${component.corner}`;
                } else if (component.type === 'ParticleComponent') {
                    info = '‚ú® Particles';
                } else if (component.type === 'LogoComponent') {
                    info = '‚≠ï Logo';
                } else if (component.type === 'SlideshowComponent') {
                    info = `üì∏ Slideshow (${component.images.length} imgs)`;
                } else {
                    info = component.type;
                }
                
                div.innerHTML = `
                    <span class="component-name" title="${id}">${info}</span>
                    <div>
                        <button class="btn" onclick="removeComponent('${id}')" title="Remove">‚ùå</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        /**
         * Update layer list
         */
        function updateLayerList() {
            const list = document.getElementById('layerList');
            list.innerHTML = '';
            
            layerManager.getAllLayers().reverse().forEach(layer => {
                const div = document.createElement('div');
                div.className = 'layer-item' + (layer.id === selectedLayer ? ' active' : '');
                div.innerHTML = `
                    <div class="layer-name">${layer.name} (${layer.components.length})</div>
                    <div class="layer-controls">
                        <button class="btn" onclick="selectLayer('${layer.id}')">Select</button>
                        <button class="btn" onclick="toggleLayerVisible('${layer.id}')">${layer.visible ? 'üëÅÔ∏è' : 'üö´'}</button>
                        <button class="btn" onclick="toggleLayerLocked('${layer.id}')">${layer.locked ? 'üîí' : 'üîì'}</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        /**
         * Layer controls
         */
        function createNewLayer() {
            const name = prompt('Layer name:', `Layer ${layerManager.layers.size + 1}`);
            if (name) {
                layerManager.createLayer(name);
                updateLayerList();
            }
        }
        
        function selectLayer(layerId) {
            selectedLayer = layerId;
            updateLayerList();
        }
        
        function toggleLayerVisible(layerId) {
            const layer = layerManager.getLayer(layerId);
            layerManager.setLayerVisible(layerId, !layer.visible);
            updateLayerList();
        }
        
        function toggleLayerLocked(layerId) {
            const layer = layerManager.getLayer(layerId);
            layerManager.setLayerLocked(layerId, !layer.locked);
            updateLayerList();
        }
        
        function deleteSelectedLayer() {
            if (selectedLayer) {
                layerManager.deleteLayer(selectedLayer);
                selectedLayer = layerManager.layerOrder[0];
                updateLayerList();
            }
        }
        
        /**
         * Grid controls
         */
        function toggleGridSnap() {
            gridSystem.setEnabled(!gridSystem.enabled);
            document.getElementById('gridSnapBtn').textContent = 'Snap: ' + (gridSystem.enabled ? 'ON' : 'OFF');
            document.getElementById('gridSnapBtn').classList.toggle('active', gridSystem.enabled);
        }
        
        function toggleGridShow() {
            gridSystem.toggleGrid();
            document.getElementById('gridShowBtn').textContent = 'Show: ' + (gridSystem.showGrid ? 'ON' : 'OFF');
            document.getElementById('gridShowBtn').classList.toggle('active', gridSystem.showGrid);
        }
        
        function updateGridSize(value) {
            gridSystem.setGridSize(parseInt(value));
            document.getElementById('gridSizeValue').textContent = value;
        }
        
        /**
         * Export/Import
         */
        function exportScene() {
            const scene = {
                components: componentManager.exportConfig(),
                layers: layerManager.exportConfig(),
                grid: gridSystem.exportConfig()
            };
            const json = JSON.stringify(scene, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rave-scene.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importScene() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const scene = JSON.parse(event.target.result);
                        componentManager.importConfig(scene.components);
                        layerManager.importConfig(scene.layers);
                        updateComponentList();
                        updateLayerList();
                    } catch (error) {
                        alert('Invalid file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        /**
         * Toggle panels
         */
        function togglePanels() {
            panelsVisible = !panelsVisible;
            document.getElementById('leftPanel').style.display = panelsVisible ? 'block' : 'none';
            document.getElementById('rightPanel').style.display = panelsVisible ? 'block' : 'none';
            document.getElementById('topBar').style.display = panelsVisible ? 'flex' : 'none';
            document.getElementById('bottomBar').style.display = panelsVisible ? 'flex' : 'none';
        }
        
        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    togglePanels();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    if (isRunning) stop(); else start();
                }
            });
            
            // Button event listeners (replacing onclick inline)
            document.getElementById('startBtn').addEventListener('click', start);
            document.getElementById('stopBtn').addEventListener('click', stop);
            document.getElementById('togglePanelsBtn').addEventListener('click', togglePanels);
            
            console.log('‚úÖ Event listeners attached');
        }
        
        // Expose functions for inline onclick handlers in panels
        window.addComponent = addComponent;
        window.removeComponent = removeComponent;
        window.loadPreset = loadPreset;
        window.clearAll = clearAll;
        window.createNewLayer = createNewLayer;
        window.deleteSelectedLayer = deleteSelectedLayer;
        window.setActiveLayer = setActiveLayer;
        window.toggleLayerVisibility = toggleLayerVisibility;
        window.toggleLayerLock = toggleLayerLock;
        window.toggleGridSnap = toggleGridSnap;
        window.toggleGridShow = toggleGridShow;
        window.updateGridSize = updateGridSize;
        
        // Initialize
        window.addEventListener('load', init);
    </script>
</body>
</html>
